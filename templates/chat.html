<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äºšæ‰˜è‰ - èŠå¤©å®¤</title>
    <style>
        /* CSS Variables for Theme */
        :root {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-color: #e2e8f0;
            --accent-color: #0ea5e9;
            --secondary-color: #94a3b8;
            --border-color: #334155;
            --success-color: #10b981;
            --message-own: #0369a1;
            --message-other: #334155;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            background-attachment: fixed;
            height: 100vh;
            display: flex;
            flex-direction: column;
            margin: 0;
            padding: 0;
        }
        
        .header {
            background-color: var(--card-bg);
            color: var(--accent-color);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .header h1 {
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: transparent;
            margin: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            border: 1px solid var(--border-color);
        }
        
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: transparent;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            background-color: transparent;
            border-radius: 12px;
            max-width: 70%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            border: 1px solid var(--border-color);
        }
        
        .message:hover {
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        
        .message.own {
            margin-left: auto;
            background-color: var(--message-own);
        }
        
        .message-header {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--accent-color);
        }
        
        .message-content {
            word-wrap: break-word;
            line-height: 1.5;
            color: var(--text-color);
        }
        
        .message-content iframe {
            border: none;
            border-radius: 5px;
            margin-top: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: transform 0.2s ease;
        }
        
        .message-content iframe:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        @media (max-width: 768px) {
            .message-content iframe {
                width: 100% !important;
                height: 280px !important;
            }
        }
        
        .input-area {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            background-color: var(--card-bg);
        }
        
        .function-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .function-buttons button {
            flex: 1;
            min-width: 100px;
        }
        
        .input-container {
            display: flex;
            gap: 10px;
        }
        
        input[type="text"] {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 16px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: border-color 0.3s ease;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: var(--accent-color);
        }
        
        button {
            padding: 12px 20px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        button:hover {
            background-color: #0284c7;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .user-list {
            width: 250px;
            background-color: transparent;
            margin: 10px 10px 10px 0;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
        }
        
        .user-list-header {
            padding: 15px;
            background-color: transparent;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
            font-weight: bold;
            color: var(--accent-color);
        }
        
        .users {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background-color: transparent;
        }
        
        .user {
            padding: 10px;
            margin-bottom: 5px;
            background-color: transparent;
            border-radius: 5px;
            color: var(--text-color);
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }
        
        .user:hover {
            background-color: var(--message-other);
        }
        
        .emoji-btn {
            background-color: var(--accent-color);
        }
        
        .emoji-btn:hover {
            background-color: #0284c7;
        }
        
        .function-btn {
            background-color: var(--border-color);
            font-size: 14px;
            padding: 12px 10px;
        }
        
        .function-btn:hover {
            background-color: var(--message-other);
        }
        
        /* å¤©æ°”èƒŒæ™¯æ ·å¼ - æ²‰æµ¸å¼ä½“éªŒ */
        .weather-sunny {
            background-image: linear-gradient(135deg, #FFEB3B 0%, #FFC107 50%, #FF9800 100%);
            animation: sunny-sky 30s infinite linear;
        }
        
        .weather-cloudy {
            background-image: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 50%, #90CAF9 100%);
            animation: cloudy-sky 20s infinite linear;
        }
        
        .weather-rainy {
            background-image: linear-gradient(135deg, #455A64 0%, #607D8B 50%, #78909C 100%);
            animation: rainy-sky 15s infinite linear;
        }
        
        .weather-snowy {
            background-image: linear-gradient(135deg, #ECEFF1 0%, #CFD8DC 50%, #B0BEC5 100%);
            animation: snowy-sky 25s infinite linear;
        }
        
        /* å¤©æ°”åŠ¨ç”»æ•ˆæœ */
        @keyframes sunny-sky {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 0%; }
        }
        
        @keyframes cloudy-sky {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 0%; }
        }
        
        @keyframes rainy-sky {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }
        
        @keyframes snowy-sky {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 0%; }
        }
        
        /* éŸ³ä¹å¡ç‰‡æ ·å¼ */
        .music-card {
            background-color: transparent;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            margin-top: 10px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: 1px solid var(--border-color);
        }
        
        .music-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        }
        
        .music-info {
            margin-bottom: 12px;
        }
        
        .music-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 5px;
        }
        
        .music-artist {
            font-size: 14px;
            color: var(--secondary-color);
        }
        
        .music-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .music-play-btn, .music-stop-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 16px;
            padding: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .music-play-btn:hover, .music-stop-btn:hover {
            background-color: #0284c7;
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .music-stop-btn {
            background-color: #ef4444;
        }
        
        .music-stop-btn:hover {
            background-color: #dc2626;
        }
        
        .music-progress-container {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .music-progress-bar {
            flex: 1;
            height: 6px;
            background-color: var(--border-color);
            border-radius: 3px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
        }
        
        .music-progress {
            height: 100%;
            background-color: var(--success-color);
            width: 0%;
            transition: width 0.1s linear;
            border-radius: 3px;
        }
        
        .music-time {
            font-size: 12px;
            color: var(--secondary-color);
            min-width: 40px;
            text-align: right;
        }
        
        /* éŸ³ä¹é€šçŸ¥æ ·å¼ */
        .message.music-notification {
            background-color: transparent;
            border-left: 4px solid var(--accent-color);
            border-radius: 12px;
        }
        
        .logout-btn {
            background-color: #ef4444;
        }
        
        .logout-btn:hover {
            background-color: #dc2626;
        }
        
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .user-list {
                width: auto;
                margin: 0 10px 10px;
                height: 150px;
            }
        }
        

        
        /* éŸ³ä¹é€šçŸ¥æ ·å¼ */
        .music-notification {
            background: transparent;
            border-left: 4px solid #3498db;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .music-notification .message-header {
            color: #3498db;
            font-weight: bold;
        }

        /* æ–°é—»æ ·å¼ */
        .news-container {
            padding: 10px;
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .news-item {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .news-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .news-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--text-color);
            font-size: 16px;
        }

        .news-image {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        /* å›¾ç‰‡æ ·å¼ */
        .image-container {
            padding: 10px;
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .image-item {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .image-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .image-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--text-color);
            font-size: 16px;
            text-align: center;
        }

        .image-display {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            display: block;
            margin: 0 auto;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes gradientBG {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>äºšæ‰˜è‰ - èŠå¤©å®¤</h1>
        <button id="logout" class="logout-btn">é€€å‡º</button>
    </div>
    
    <div class="container">
        <div class="chat-area">
            <div id="messages" class="messages"></div>
            <div class="input-area">
                <div class="function-buttons">
                    <button id="emoji-btn" class="emoji-btn">ğŸ˜€</button>
                    <button id="music-btn" class="function-btn">@éŸ³ä¹</button>
                    <button id="news-btn" class="function-btn">@æ–°é—»60s</button>
                    <button id="weather-btn" class="function-btn">@å¤©æ°”</button>
                    <button id="movie-btn" class="function-btn">@ç”µå½±</button>
                </div>
                <div class="input-container">
                    <input id="message-input" type="text" placeholder="è¾“å…¥æ¶ˆæ¯ï¼Œæ”¯æŒ@ç”µå½± URLæ ¼å¼çš„æŒ‡ä»¤...">
                    <button id="send-btn">å‘é€</button>
                </div>
            </div>
        </div>
        
        <div class="user-list">
            <div class="user-list-header">åœ¨çº¿ç”¨æˆ·</div>
            <div id="users" class="users"></div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>/* é¡µé¢ç‰ˆæœ¬: 2025-12-04-16:00 */
    
        // è·å–URLå‚æ•°
        const urlParams = new URLSearchParams(window.location.search);
        const username = urlParams.get('username');
        
        if (!username) {
            window.location.href = '/';
        }
        
        // è¿æ¥Socket.IO
        const socket = io({
            transports: ['websocket', 'polling'],
            timeout: 5000,
            reconnection: true,
            reconnectionAttempts: 5,
            reconnectionDelay: 1000
        });
        
        // æ·»åŠ è°ƒè¯•äº‹ä»¶ç›‘å¬å™¨
        socket.on('connect', () => {
            console.log('Socket.IOè¿æ¥æˆåŠŸ:', socket.id);
        });
        
        socket.on('disconnect', (reason) => {
            console.log('Socket.IOè¿æ¥æ–­å¼€:', reason);
        });
        
        socket.on('connect_error', (error) => {
            console.error('Socket.IOè¿æ¥é”™è¯¯:', error);
        });
        
        socket.on('reconnect_attempt', (attemptNumber) => {
            console.log('Socket.IOé‡æ–°è¿æ¥å°è¯•:', attemptNumber);
        });
        
        socket.on('reconnect', (attemptNumber) => {
            console.log('Socket.IOé‡æ–°è¿æ¥æˆåŠŸ:', attemptNumber);
        });
        
        socket.on('reconnect_error', (error) => {
            console.error('Socket.IOé‡æ–°è¿æ¥é”™è¯¯:', error);
        });
        
        socket.on('reconnect_failed', () => {
            console.error('Socket.IOé‡æ–°è¿æ¥å¤±è´¥');
        });
        
        // åŠ å…¥èŠå¤©å®¤
        socket.emit('join', { username });
        
        // ç›‘å¬æ¶ˆæ¯
        socket.on('message', handleMessage);
        
        // ç›‘å¬@æŒ‡ä»¤ç»“æœ
        socket.on('at_command_result', handleAtCommandResult);
        
        // ç›‘å¬éŸ³ä¹æ’­æ”¾åŒæ­¥äº‹ä»¶
        socket.on('music_playing', handleMusicPlaying);
        
        // ç›‘å¬ç”¨æˆ·åŠ å…¥
        socket.on('user_joined', function(data) {
            const message = document.createElement('div');
            message.className = 'message';
            message.innerHTML = `<div class="message-content" style="text-align: center; color: #666;">${data.username} åŠ å…¥äº†èŠå¤©å®¤</div>`;
            document.getElementById('messages').appendChild(message);
            scrollToBottom();
        });
        
        // ç›‘å¬ç”¨æˆ·ç¦»å¼€
        socket.on('user_left', function(data) {
            const message = document.createElement('div');
            message.className = 'message';
            message.innerHTML = `<div class="message-content" style="text-align: center; color: #666;">${data.username} ç¦»å¼€äº†èŠå¤©å®¤</div>`;
            document.getElementById('messages').appendChild(message);
            scrollToBottom();
        });
        
        // ç›‘å¬ç”¨æˆ·åˆ—è¡¨æ›´æ–°
        socket.on('update_users', function(data) {
            const usersDiv = document.getElementById('users');
            usersDiv.innerHTML = '';
            // æœåŠ¡å™¨è¿”å›çš„æ˜¯åŒ…å«userså±æ€§çš„å¯¹è±¡
            if (data && data.users) {
                data.users.forEach(user => {
                    const userDiv = document.createElement('div');
                    userDiv.className = 'user';
                    
                    // æ˜¾ç¤ºç”¨æˆ·å¤´åƒ
                    if (user === 'èåœå­') {
                        userDiv.innerHTML = '<img src="/static/images/luobzi.svg" style="width:24px; height:24px; border-radius:50%; margin-right:8px; vertical-align:middle;">' + user;
                    } else if (data.user_avatars && data.user_avatars[user]) {
                        userDiv.innerHTML = `<img src="${data.user_avatars[user]}" style="width:24px; height:24px; border-radius:50%; margin-right:8px; vertical-align:middle;">${user}`;
                    } else {
                        userDiv.textContent = user;
                    }
                    
                    usersDiv.appendChild(userDiv);
                });
            }
            
            // è®¾ç½®èŠå¤©å®¤èƒŒæ™¯å£çº¸
            if (data.wallpaper) {
                document.body.style.backgroundImage = `url('${data.wallpaper}')`;
                document.body.style.backgroundSize = 'cover';
                document.body.style.backgroundPosition = 'center';
                document.body.style.backgroundRepeat = 'no-repeat';
                document.body.style.backgroundAttachment = 'fixed';
            }
        });
        
        // å‘é€æ¶ˆæ¯
        document.getElementById('send-btn').addEventListener('click', sendMessage);
        document.getElementById('message-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // é€€å‡ºæŒ‰é’®
        document.getElementById('logout').addEventListener('click', function() {
            // æ–­å¼€socketè¿æ¥
            socket.disconnect();
            // è·³è½¬åˆ°ç™»å½•é¡µé¢
            window.location.href = '/login';
        });
        
        // ç›‘å¬é”™è¯¯æ¶ˆæ¯
        socket.on('error', function(data) {
            alert('é”™è¯¯: ' + data.message);
            // å¦‚æœæ˜¯ç”¨æˆ·éªŒè¯é”™è¯¯ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
            window.location.href = '/login';
        });
        
        // è¡¨æƒ…æŒ‰é’®
        document.getElementById('emoji-btn').addEventListener('click', function() {
            const emojis = ['ğŸ˜€', 'ğŸ˜‚', 'ğŸ˜', 'ğŸ¤”', 'ğŸ˜¢', 'ğŸ‘', 'â¤ï¸', 'ğŸ‰'];
            const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
            document.getElementById('message-input').value += randomEmoji;
        });
        
        // @éŸ³ä¹æŒ‰é’®
        document.getElementById('music-btn').addEventListener('click', function() {
            // ç›´æ¥å‘é€@éŸ³ä¹å‘½ä»¤ï¼Œä¸éœ€è¦è¾“å…¥å…³é”®è¯
            const message = `@éŸ³ä¹`;
            socket.emit('message', { username, message });
        });
        
        // @æ–°é—»60sæŒ‰é’®
        document.getElementById('news-btn').addEventListener('click', function() {
            const message = '@æ–°é—»';
            socket.emit('message', { username, message });
        });
        
        // åˆ›å»ºè‡ªå®šä¹‰è¾“å…¥æ¨¡æ€æ¡†çš„é€šç”¨å‡½æ•°
        function showInputModal(title, placeholder, callback) {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¾“å…¥æ¨¡æ€æ¡†
            let modal = document.getElementById('input-modal');
            if (modal) {
                modal.remove();
            }
            
            // åˆ›å»ºè‡ªå®šä¹‰è¾“å…¥æ¨¡æ€æ¡†
            modal = document.createElement('div');
            modal.id = 'input-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background-color: #fff;
                padding: 20px;
                border-radius: 8px;
                width: 90%;
                max-width: 400px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            `;
            
            const modalTitle = document.createElement('h3');
            modalTitle.textContent = title;
            modalTitle.style.marginTop = '0';
            
            const inputField = document.createElement('input');
            inputField.type = 'text';
            inputField.id = 'modal-input';
            inputField.placeholder = placeholder;
            inputField.style.cssText = `
                width: 100%;
                padding: 10px;
                margin: 10px 0;
                border: 1px solid #ddd;
                border-radius: 4px;
                box-sizing: border-box;
            `;
            
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = `
                display: flex;
                justify-content: flex-end;
                gap: 10px;
                margin-top: 15px;
            `;
            
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'å–æ¶ˆ';
            cancelBtn.style.cssText = `
                padding: 8px 16px;
                border: 1px solid #ddd;
                border-radius: 4px;
                background-color: #f5f5f5;
                cursor: pointer;
            `;
            cancelBtn.addEventListener('click', function() {
                modal.remove();
            });
            
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = 'ç¡®å®š';
            confirmBtn.style.cssText = `
                padding: 8px 16px;
                border: none;
                border-radius: 4px;
                background-color: #6200ea;
                color: white;
                cursor: pointer;
            `;
            confirmBtn.addEventListener('click', function() {
                const value = document.getElementById('modal-input').value;
                callback(value && value.trim() ? value.trim() : null);
                modal.remove();
            });
            
            buttonContainer.appendChild(cancelBtn);
            buttonContainer.appendChild(confirmBtn);
            
            modalContent.appendChild(modalTitle);
            modalContent.appendChild(inputField);
            modalContent.appendChild(buttonContainer);
            modal.appendChild(modalContent);
            
            // æ·»åŠ é”®ç›˜äº‹ä»¶æ”¯æŒ
            inputField.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    confirmBtn.click();
                }
            });
            
            // æ·»åŠ ç‚¹å‡»å¤–éƒ¨å…³é—­æ”¯æŒ
            modal.addEventListener('click', function(event) {
                if (event.target === modal) {
                    modal.remove();
                }
            });
            
            document.body.appendChild(modal);
            // è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†
            inputField.focus();
        }
        
        // @å¤©æ°”æŒ‰é’®
        document.getElementById('weather-btn').addEventListener('click', function() {
            showInputModal('è¯·è¾“å…¥åŸå¸‚åç§°:', 'ä¾‹å¦‚: åŒ—äº¬ ä¸Šæµ·', function(city) {
                if (city) {
                    const message = `@å¤©æ°” ${city}`;
                    socket.emit('message', { username, message });
                }
            });
        });
        
        // @ç”µå½±æŒ‰é’®
        document.getElementById('movie-btn').addEventListener('click', function() {
            showInputModal('è¯·è¾“å…¥ç”µå½±URL:', 'ä¾‹å¦‚: https://www.example.com/movie', function(url) {
                if (url) {
                    const message = `@ç”µå½± ${url}`;
                    socket.emit('message', { username, message });
                }
            });
        });
        
        function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();
            
            if (message) {
                socket.emit('message', { username, message });
                messageInput.value = '';
            }
        }
        
        function handleMessage(data) {
            // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å­˜åœ¨ï¼Œé¿å…é‡å¤æ·»åŠ 
            const messagesContainer = document.getElementById('messages');
            const existingMessages = Array.from(messagesContainer.querySelectorAll('.message'));
            const isDuplicate = existingMessages.some(msg => 
                msg.querySelector('.message-header')?.textContent === data.username &&
                msg.querySelector('.message-content')?.textContent === data.message &&
                msg.querySelector('.message-content')?.querySelector('iframe') === null
            );
            
            if (isDuplicate) {
                return; // é¿å…æ·»åŠ é‡å¤æ¶ˆæ¯
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = data.username === username ? 'message own' : 'message';
            
            const messageHeader = document.createElement('div');
            messageHeader.className = 'message-header';
            
            // æ˜¾ç¤ºç”¨æˆ·å¤´åƒ
            if (data.username === 'èåœå­') {
                // èåœå­ä½¿ç”¨å›ºå®šå¤´åƒ
                messageHeader.innerHTML = '<img src="/static/images/luobzi.svg" style="width:24px; height:24px; border-radius:50%; margin-right:8px; vertical-align:middle;">' + data.username;
            } else if (data.avatar) {
                // å…¶ä»–ç”¨æˆ·ä½¿ç”¨APIè·å–çš„å¤´åƒ
                messageHeader.innerHTML = `<img src="${data.avatar}" style="width:24px; height:24px; border-radius:50%; margin-right:8px; vertical-align:middle;">${data.username}`;
            } else {
                // æ²¡æœ‰å¤´åƒæ—¶åªæ˜¾ç¤ºç”¨æˆ·å
                messageHeader.textContent = data.username;
            }
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«@ç”µå½±æŒ‡ä»¤
            if (data.message && data.message.includes('@ç”µå½±')) {
                parseMessageWithMovie(data.message, messageContent);
            } else {
                // å¯¹äºæ™®é€šæ¶ˆæ¯ï¼Œç›´æ¥æ˜¾ç¤ºæ–‡æœ¬
                messageContent.textContent = data.message;
            }
            
            messageDiv.appendChild(messageHeader);
            messageDiv.appendChild(messageContent);
            
            // ç¡®ä¿æ¶ˆæ¯æŒ‰é¡ºåºæ·»åŠ åˆ°å®¹å™¨æœ«å°¾
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }
        
        // è§£ææ¶ˆæ¯ä¸­çš„@ç”µå½±æŒ‡ä»¤
        function parseMessageWithMovie(message, container) {
            // åŒ¹é…@ç”µå½± URLæ ¼å¼ï¼Œæ”¯æŒä¸­æ–‡å’Œè‹±æ–‡å†’å·ï¼Œä»¥åŠå¯é€‰çš„ç©ºæ ¼
            const movieRegex = /@ç”µå½±[ï¼š:]*\s*([^\s]+)/g;
            let match;
            let lastIndex = 0;
            
            // å¯¹æ¶ˆæ¯è¿›è¡ŒHTMLè½¬ä¹‰ï¼Œé˜²æ­¢XSSæ”»å‡»
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            while ((match = movieRegex.exec(message)) !== null) {
                // æ·»åŠ åŒ¹é…å‰çš„æ–‡æœ¬ï¼ˆè½¬ä¹‰HTMLï¼‰
                if (match.index > lastIndex) {
                    const textNode = document.createTextNode(escapeHtml(message.substring(lastIndex, match.index)));
                    container.appendChild(textNode);
                }
                
                // è·å–ç”µå½±URL
                const movieUrl = match[1];
                
                // ç®€å•çš„URLæ ¼å¼éªŒè¯
                let parsedUrl = movieUrl;
                // å¦‚æœURLæ²¡æœ‰åè®®ï¼Œæ·»åŠ http://
                if (!parsedUrl.startsWith('http://') && !parsedUrl.startsWith('https://')) {
                    parsedUrl = 'http://' + parsedUrl;
                }
                
                // åˆ›å»ºä¸€ä¸ªåŒ…å«iframeçš„div
                const iframeContainer = document.createElement('div');
                iframeContainer.style.marginTop = '10px';
                iframeContainer.style.marginBottom = '10px';
                iframeContainer.style.position = 'relative';
                
                // åˆ›å»ºåŠ è½½ä¸­çš„æç¤º
                const loadingIndicator = document.createElement('div');
                loadingIndicator.textContent = 'æ­£åœ¨åŠ è½½è§†é¢‘...';
                loadingIndicator.style.textAlign = 'center';
                loadingIndicator.style.padding = '10px';
                loadingIndicator.style.color = '#666';
                loadingIndicator.style.backgroundColor = '#f5f5f5';
                loadingIndicator.style.borderRadius = '5px';
                loadingIndicator.id = 'loading-' + Date.now();
                
                // åˆ›å»ºiframeå…ƒç´ 
                const iframe = document.createElement('iframe');
                iframe.src = parsedUrl;
                iframe.width = '400';
                iframe.height = '400';
                iframe.allowFullscreen = true;
                iframe.style.borderRadius = '5px';
                iframe.style.border = '1px solid #ddd';
                iframe.style.display = 'none';
                
                // iframeåŠ è½½å®Œæˆåéšè—åŠ è½½æç¤º
                iframe.onload = function() {
                    this.style.display = 'block';
                    if (loadingIndicator && loadingIndicator.parentNode) {
                        loadingIndicator.parentNode.removeChild(loadingIndicator);
                    }
                };
                
                // iframeåŠ è½½å¤±è´¥çš„å¤„ç†
                iframe.onerror = function() {
                    if (loadingIndicator) {
                        loadingIndicator.textContent = 'è§†é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥URL';
                        loadingIndicator.style.color = '#f44336';
                    }
                };
                
                // æ·»åŠ å…ƒç´ åˆ°å®¹å™¨
                iframeContainer.appendChild(loadingIndicator);
                iframeContainer.appendChild(iframe);
                container.appendChild(iframeContainer);
                
                lastIndex = match.index + match[0].length;
            }
            
            // æ·»åŠ å‰©ä½™çš„æ–‡æœ¬ï¼ˆè½¬ä¹‰HTMLï¼‰
            if (lastIndex < message.length) {
                const textNode = document.createTextNode(escapeHtml(message.substring(lastIndex)));
                container.appendChild(textNode);
            }
        }
        
        // å¤„ç†@æŒ‡ä»¤ç»“æœ
        function handleAtCommandResult(data) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            
            const messageHeader = document.createElement('div');
            messageHeader.className = 'message-header';
            messageHeader.textContent = `èåœå­ - @${data.command}`;
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            // æ ¹æ®ä¸åŒçš„å‘½ä»¤ç±»å‹æ˜¾ç¤ºä¸åŒçš„å†…å®¹
            switch(data.command) {
                case 'å¤©æ°”':
                    // æ˜¾ç¤ºå¤©æ°”ä¿¡æ¯
                    displayWeatherInfo(data.result, messageContent);
                    break;
                case 'æ–°é—»':
                    // æ˜¾ç¤ºæ–°é—»åˆ—è¡¨
                    displayNewsInfo(data.result, messageContent);
                    break;
                case 'éŸ³ä¹':
                    // æ˜¾ç¤ºéŸ³ä¹æ’­æ”¾å™¨
                    displayMusicPlayer(data.result, messageContent);
                    break;
                case 'img':
                    // æ˜¾ç¤ºå›¾ç‰‡
                    displayImageInfo(data.result, messageContent);
                    break;
                default:
                    // æ˜¾ç¤ºæ™®é€šæ–‡æœ¬ç»“æœ
                    messageContent.textContent = data.result;
            }
            
            messageDiv.appendChild(messageHeader);
            messageDiv.appendChild(messageContent);
            
            document.getElementById('messages').appendChild(messageDiv);
            scrollToBottom();
        }
        
        // æ˜¾ç¤ºå¤©æ°”ä¿¡æ¯
        function displayWeatherInfo(weatherData, container) {
            if (typeof weatherData === 'string') {
                container.textContent = weatherData;
                return;
            }
            
            // åˆ›å»ºå¤©æ°”å¡ç‰‡
            const weatherCard = document.createElement('div');
            weatherCard.className = 'weather-card';
            weatherCard.innerHTML = `
                <div class="weather-city">${weatherData.city || 'æœªçŸ¥åŸå¸‚'}</div>
                <div class="weather-main">${weatherData.main || 'æœªçŸ¥'}</div>
                <div class="weather-temp">${weatherData.temp || '--'}Â°C</div>
                <div class="weather-desc">${weatherData.description || ''}</div>
                <div class="weather-detail">
                    <span>æ¹¿åº¦: ${weatherData.humidity || '--'}%</span>
                    <span>é£é€Ÿ: ${weatherData.wind_speed || '--'} m/s</span>
                </div>
            `;
            
            container.appendChild(weatherCard);
            
            // æ›´æ–°èƒŒæ™¯æ ·å¼ï¼ˆæ²‰æµ¸å¼ä½“éªŒï¼‰
            updateBackgroundByWeather(weatherData.main);
        }
        
        // æ˜¾ç¤ºæ–°é—»åˆ—è¡¨
        function displayNewsInfo(newsData, container) {
            if (typeof newsData === 'string') {
                container.textContent = newsData;
                return;
            }
            
            // åˆ›å»ºæ–°é—»å®¹å™¨
            const newsContainer = document.createElement('div');
            newsContainer.className = 'news-container';
            
            if (newsData.list && Array.isArray(newsData.list)) {
                newsData.list.forEach(news => {
                    const newsItem = document.createElement('div');
                    newsItem.className = 'news-item';
                    newsItem.innerHTML = `
                        <div class="news-title">${news.title || 'æ— æ ‡é¢˜'}</div>
                        ${news.image ? `<img src="${news.image}" class="news-image">` : ''}
                    `;
                    newsContainer.appendChild(newsItem);
                });
            } else {
                newsContainer.textContent = 'æš‚æ— æ–°é—»æ•°æ®';
            }
            
            container.appendChild(newsContainer);
        }
        
        // æ˜¾ç¤ºå›¾ç‰‡ä¿¡æ¯
        function displayImageInfo(imageData, container) {
            if (typeof imageData === 'string') {
                container.textContent = imageData;
                return;
            }
            
            // åˆ›å»ºå›¾ç‰‡å®¹å™¨
            const imageContainer = document.createElement('div');
            imageContainer.className = 'image-container';
            
            if (imageData.list && Array.isArray(imageData.list)) {
                imageData.list.forEach(image => {
                    const imageItem = document.createElement('div');
                    imageItem.className = 'image-item';
                    imageItem.innerHTML = `
                        <div class="image-title">${image.title || 'å›¾ç‰‡'}</div>
                        ${image.image ? `<img src="${image.image}" class="image-display">` : ''}
                    `;
                    imageContainer.appendChild(imageItem);
                });
            } else {
                imageContainer.textContent = 'æš‚æ— å›¾ç‰‡æ•°æ®';
            }
            
            container.appendChild(imageContainer);
        }
        
        // å…¨å±€å˜é‡ï¼šè·Ÿè¸ªå½“å‰æ´»è·ƒçš„éŸ³é¢‘å…ƒç´ å’ŒéŸ³ä¹å¡ç‰‡
        let activeAudioElement = null;
        let activeMusicCard = null;
        let isAudioStopping = false;
        let isAudioOperationInProgress = false;
        
        // åœæ­¢å¹¶æ¸…ç†å½“å‰æ´»è·ƒçš„éŸ³é¢‘å…ƒç´ 
        function stopActiveAudio() {
            if (activeAudioElement) {
                try {
                    isAudioStopping = true;
                    
                    // æš‚åœéŸ³é¢‘å¹¶é‡ç½®æ’­æ”¾æ—¶é—´
                    activeAudioElement.pause();
                    activeAudioElement.currentTime = 0;
                    
                    // é‡ç½®æ’­æ”¾æŒ‰é’®çŠ¶æ€
                    if (activeMusicCard) {
                        const playIcon = activeMusicCard.querySelector('.play-icon');
                        const pauseIcon = activeMusicCard.querySelector('.pause-icon');
                        if (playIcon) playIcon.style.display = 'inline';
                        if (pauseIcon) pauseIcon.style.display = 'none';
                    }
                } catch (error) {
                    console.error('åœæ­¢æ´»è·ƒéŸ³é¢‘å¤±è´¥:', error);
                } finally {
                    // ä»DOMä¸­ç§»é™¤éŸ³é¢‘å…ƒç´ 
                    if (activeAudioElement && activeAudioElement.parentNode) {
                        try {
                            console.log('ä»DOMä¸­ç§»é™¤æ´»è·ƒéŸ³é¢‘å…ƒç´ :', activeAudioElement.id);
                            document.body.removeChild(activeAudioElement);
                        } catch (error) {
                            console.error('ç§»é™¤æ´»è·ƒéŸ³é¢‘å…ƒç´ å¤±è´¥:', error);
                        }
                    }
                    
                    // é‡ç½®æ´»è·ƒå¼•ç”¨
                    activeAudioElement = null;
                    activeMusicCard = null;
                    isAudioStopping = false;
                    
                    // å»¶è¿Ÿé‡ç½®æ“ä½œçŠ¶æ€ï¼Œç¡®ä¿æœ‰è¶³å¤Ÿæ—¶é—´å®Œæˆæ¸…ç†
                    setTimeout(() => {
                        isAudioOperationInProgress = false;
                        console.log('éŸ³é¢‘æ“ä½œçŠ¶æ€å·²é‡ç½®');
                    }, 200);
                }
            }
        }
        
        // æ˜¾ç¤ºéŸ³ä¹æ’­æ”¾å™¨
        function displayMusicPlayer(musicData, container) {
            if (typeof musicData === 'string') {
                container.textContent = musicData;
                return;
            }
            
            // 1. é¦–å…ˆæ¸…ç†æ‰€æœ‰æ—§çš„éŸ³ä¹å¡ç‰‡å’ŒéŸ³é¢‘å…ƒç´ 
            console.log('å¼€å§‹æ¸…ç†æ—§çš„éŸ³ä¹å…ƒç´ ...');
            
            // æ¸…ç†å½“å‰å®¹å™¨ä¸­çš„å†…å®¹
            container.innerHTML = '';
            
            // åœæ­¢æ‰€æœ‰æ­£åœ¨æ’­æ”¾çš„éŸ³é¢‘
            const allAudios = document.querySelectorAll('audio');
            allAudios.forEach(audio => {
                console.log('åœæ­¢å¹¶ç§»é™¤æ‰€æœ‰éŸ³é¢‘å…ƒç´ :', audio.id);
                try {
                    audio.pause();
                    audio.currentTime = 0;
                    if (audio.parentNode) {
                        document.body.removeChild(audio);
                    }
                } catch (error) {
                    console.error('åœæ­¢å¹¶ç§»é™¤éŸ³é¢‘å…ƒç´ å¤±è´¥:', error);
                }
            });
            
            // æ¸…ç†æ‰€æœ‰éŸ³ä¹å¡ç‰‡
            const allMusicCards = document.querySelectorAll('.music-card');
            allMusicCards.forEach(card => {
                console.log('æ¸…ç†æ—§éŸ³ä¹å¡ç‰‡:', card.dataset.musicId);
                if (card.parentNode) {
                    card.parentNode.removeChild(card);
                }
            });
            
            // é‡ç½®æ‰€æœ‰çŠ¶æ€
            activeAudioElement = null;
            activeMusicCard = null;
            isAudioStopping = false;
            isAudioOperationInProgress = false;
            
            // æ¸…ç†å½“å‰å®¹å™¨ä¸­çš„å†…å®¹ï¼ˆå†æ¬¡ç¡®ä¿ï¼‰
            container.innerHTML = '';
            
            // é‡æ–°æŸ¥è¯¢æ‰€æœ‰éŸ³ä¹å¡ç‰‡ï¼ˆåº”è¯¥ä¸ºç©ºï¼‰
            const remainingCards = document.querySelectorAll('.music-card');
            console.log('æ¸…ç†åå‰©ä½™éŸ³ä¹å¡ç‰‡æ•°é‡:', remainingCards.length);
            
            // åˆ›å»ºéŸ³ä¹å¡ç‰‡
            
            // 2. é‡ç½®æ´»è·ƒéŸ³é¢‘çŠ¶æ€
            console.log('é‡ç½®æ´»è·ƒéŸ³é¢‘çŠ¶æ€...');
            activeAudioElement = null;
            activeMusicCard = null;
            isAudioStopping = false;
            isAudioOperationInProgress = false;
            
            console.log('æ¸…ç†å®Œæˆï¼Œå‡†å¤‡åˆ›å»ºæ–°çš„éŸ³ä¹å¡ç‰‡...');
            
            // åˆ›å»ºéŸ³ä¹å¡ç‰‡
            const musicCard = document.createElement('div');
            musicCard.className = 'music-card';
            musicCard.dataset.musicId = musicData.id || Date.now(); // ä¸ºæ¯ä¸ªéŸ³ä¹å¡ç‰‡æ·»åŠ å”¯ä¸€ID
            
            // åˆ›å»ºéŸ³ä¹ä¿¡æ¯éƒ¨åˆ†
            const musicInfo = document.createElement('div');
            musicInfo.className = 'music-info';
            
            const musicTitle = document.createElement('div');
            musicTitle.className = 'music-title';
            musicTitle.textContent = musicData.title || 'æœªçŸ¥æ­Œæ›²';
            
            const musicArtist = document.createElement('div');
            musicArtist.className = 'music-artist';
            musicArtist.textContent = musicData.artist || 'æœªçŸ¥æ­Œæ‰‹';
            
            musicInfo.appendChild(musicTitle);
            musicInfo.appendChild(musicArtist);
            
            // åˆ›å»ºéŸ³ä¹æ§åˆ¶éƒ¨åˆ†
            const musicControls = document.createElement('div');
            musicControls.className = 'music-controls';
            
            // æ’­æ”¾æŒ‰é’®
            const playBtn = document.createElement('button');
            playBtn.className = 'music-play-btn';
            
            const playIcon = document.createElement('span');
            playIcon.className = 'play-icon';
            playIcon.textContent = 'â–¶';
            
            const pauseIcon = document.createElement('span');
            pauseIcon.className = 'pause-icon';
            pauseIcon.textContent = 'â¸';
            pauseIcon.style.display = 'none';
            
            playBtn.appendChild(playIcon);
            playBtn.appendChild(pauseIcon);
            
            // åœæ­¢æŒ‰é’®
            const stopBtn = document.createElement('button');
            stopBtn.className = 'music-stop-btn';
            stopBtn.textContent = 'â¹';
            
            // è¿›åº¦æ¡
            const progressContainer = document.createElement('div');
            progressContainer.className = 'music-progress-container';
            
            const progressBar = document.createElement('div');
            progressBar.className = 'music-progress-bar';
            
            const progress = document.createElement('div');
            progress.className = 'music-progress';
            
            progressBar.appendChild(progress);
            
            const timeDisplay = document.createElement('span');
            timeDisplay.className = 'music-time';
            timeDisplay.textContent = '0:00';
            
            progressContainer.appendChild(progressBar);
            progressContainer.appendChild(timeDisplay);
            
            // ç»„è£…æ§åˆ¶éƒ¨åˆ†
            musicControls.appendChild(playBtn);
            musicControls.appendChild(stopBtn);
            musicControls.appendChild(progressContainer);
            
            // ç»„è£…éŸ³ä¹å¡ç‰‡
            musicCard.appendChild(musicInfo);
            musicCard.appendChild(musicControls);
            
            // åˆ›å»ºéŸ³é¢‘å…ƒç´ 
            let audioElement;
            if (musicData.url) {
                console.log('åˆ›å»ºéŸ³é¢‘å…ƒç´ ï¼ŒURL:', musicData.url);
                audioElement = document.createElement('audio');
                audioElement.src = musicData.url;
                audioElement.type = 'audio/mpeg';
                audioElement.preload = 'metadata';
                
                // æ·»åŠ éŸ³é¢‘åŠ è½½äº‹ä»¶ç›‘å¬
                audioElement.addEventListener('loadedmetadata', function() {
                    console.log('éŸ³é¢‘å…ƒæ•°æ®åŠ è½½æˆåŠŸ:', audioElement.duration, 'ç§’');
                });
                
                audioElement.addEventListener('loadeddata', function() {
                    console.log('éŸ³é¢‘æ•°æ®åŠ è½½æˆåŠŸ');
                });
                
                audioElement.addEventListener('canplay', function() {
                    console.log('éŸ³é¢‘å¯ä»¥æ’­æ”¾äº†');
                });
                
                // æ·»åŠ éŸ³é¢‘é”™è¯¯å¤„ç†
                audioElement.addEventListener('error', function(e) {
                    console.error('éŸ³é¢‘åŠ è½½å¤±è´¥:', e);
                    console.error('é”™è¯¯ç±»å‹:', e.target.error.code);
                    console.error('é”™è¯¯æ¶ˆæ¯:', e.target.error.message);
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'music-error';
                    errorMsg.textContent = 'éŸ³é¢‘åŠ è½½å¤±è´¥: ' + (e.target.error ? e.target.error.message : 'æœªçŸ¥é”™è¯¯');
                    musicCard.appendChild(errorMsg);
                });
                
                // ç”Ÿæˆå”¯ä¸€çš„éŸ³é¢‘ID
                const uniqueId = Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                const audioId = 'audio-' + uniqueId;
                audioElement.id = audioId;
                musicCard.dataset.audioId = audioId;
                musicCard.dataset.musicTitle = musicData.title;
                
                console.log('æ·»åŠ éŸ³é¢‘å…ƒç´ åˆ°DOMï¼ŒID:', audioId);
                document.body.appendChild(audioElement);
                
                // éªŒè¯éŸ³é¢‘å…ƒç´ æ˜¯å¦æˆåŠŸæ·»åŠ 
                setTimeout(() => {
                    const addedAudio = document.getElementById(audioId);
                    if (addedAudio) {
                        console.log('éŸ³é¢‘å…ƒç´ éªŒè¯æˆåŠŸ:', addedAudio);
                    } else {
                        console.error('éŸ³é¢‘å…ƒç´ éªŒè¯å¤±è´¥ï¼Œæœªèƒ½åœ¨DOMä¸­æ‰¾åˆ°');
                    }
                }, 100);
                
                // ç¡®ä¿æ¯æ¬¡åªæœ‰ä¸€ä¸ªæ´»è·ƒçš„éŸ³é¢‘å…ƒç´ 
                if (activeAudioElement && activeAudioElement !== audioElement) {
                    console.log('æ–°çš„éŸ³é¢‘å¡ç‰‡åˆ›å»ºï¼Œåœæ­¢å½“å‰æ´»è·ƒéŸ³é¢‘');
                    stopActiveAudio();
                }
            } else {
                // å¦‚æœæ²¡æœ‰éŸ³é¢‘URLï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                console.log('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„éŸ³é¢‘æº');
                const errorMsg = document.createElement('div');
                errorMsg.className = 'music-error';
                errorMsg.textContent = 'æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„éŸ³é¢‘æº';
                musicCard.appendChild(errorMsg);
            }
            
            container.appendChild(musicCard);
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            if (audioElement) {
                // å·²ç»é€šè¿‡DOMåˆ›å»ºäº†è¿™äº›å…ƒç´ ï¼Œç›´æ¥ä½¿ç”¨å®ƒä»¬
                
                // æ’­æ”¾/æš‚åœæŒ‰é’®äº‹ä»¶
                playBtn.addEventListener('click', function() {
                    console.log('æ’­æ”¾æŒ‰é’®è¢«ç‚¹å‡»');
                    console.log('éŸ³é¢‘å…ƒç´ çŠ¶æ€:', audioElement);
                    
                    if (audioElement) {
                        try {
                            // æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–éŸ³é¢‘æ“ä½œæ­£åœ¨è¿›è¡Œ
                            if (isAudioOperationInProgress) {
                                console.log('æœ‰å…¶ä»–éŸ³é¢‘æ“ä½œæ­£åœ¨è¿›è¡Œï¼Œæš‚æ—¶å¿½ç•¥å½“å‰è¯·æ±‚');
                                return;
                            }
                            
                            if (audioElement.paused) {
                                // å¦‚æœå½“å‰æœ‰å…¶ä»–éŸ³é¢‘åœ¨æ’­æ”¾ï¼Œå…ˆåœæ­¢å®ƒ
                                if (activeAudioElement && activeAudioElement !== audioElement) {
                                    console.log('åœæ­¢å½“å‰æ´»è·ƒéŸ³é¢‘ï¼Œæ’­æ”¾æ–°éŸ³é¢‘');
                                    isAudioOperationInProgress = true;
                                    stopActiveAudio();
                                } else {
                                    isAudioOperationInProgress = true;
                                }
                                
                                console.log('å°è¯•æ’­æ”¾éŸ³é¢‘...');
                                
                                // ä½¿ç”¨requestAnimationFrameç¡®ä¿åœ¨æµè§ˆå™¨ä¸‹ä¸€ä¸ªå¸§æ‰§è¡Œæ’­æ”¾
                                requestAnimationFrame(() => {
                                    // ç¡®ä¿éŸ³é¢‘å…ƒç´ å­˜åœ¨ä¸”å¯ä»¥æ’­æ”¾
                                    if (!audioElement || audioElement.readyState === 0) {
                                        console.error('éŸ³é¢‘å…ƒç´ ä¸å­˜åœ¨æˆ–æœªå‡†å¤‡å¥½æ’­æ”¾');
                                        isAudioOperationInProgress = false;
                                        return;
                                    }
                                    
                                    // å†æ¬¡æ£€æŸ¥éŸ³é¢‘å…ƒç´ æ˜¯å¦çœŸçš„å·²ç»æš‚åœ
                                    if (audioElement.paused) {
                                        console.log('è°ƒç”¨audioElement.play()');
                                        audioElement.play()
                                            .then(function() {
                                                console.log('éŸ³é¢‘æ’­æ”¾æˆåŠŸ');
                                                playIcon.style.display = 'none';
                                                pauseIcon.style.display = 'inline';
                                                
                                                // æ›´æ–°æ´»è·ƒéŸ³é¢‘å…ƒç´ å’ŒéŸ³ä¹å¡ç‰‡
                                                activeAudioElement = audioElement;
                                                activeMusicCard = musicCard;
                                                
                                                // æ ¹æ®éŸ³ä¹æ›´æ–°èƒŒæ™¯é¢œè‰²
                                                if (musicData.color) {
                                                    updateBackgroundColor(musicData.color);
                                                }
                                                
                                                // å‘é€æ’­æ”¾äº‹ä»¶ç»™æœåŠ¡å™¨
                                                socket.emit('music_play', {
                                                    music: musicData,
                                                    status: 'play'
                                                });
                                            })
                                            .catch(function(error) {
                                                console.error('éŸ³é¢‘æ’­æ”¾å¤±è´¥:', error);
                                                // å°è¯•ä½¿ç”¨æ›´å¯é çš„æ–¹å¼æ’­æ”¾
                                                console.log('å°è¯•ä½¿ç”¨æ›´å¯é çš„æ–¹å¼æ’­æ”¾éŸ³é¢‘');
                                                setTimeout(() => {
                                                    audioElement.load();
                                                    setTimeout(() => {
                                                        audioElement.play().catch(e => {
                                                            console.error('ç¬¬äºŒæ¬¡å°è¯•æ’­æ”¾ä¹Ÿå¤±è´¥:', e);
                                                            const errorMsg = document.createElement('div');
                                                            errorMsg.className = 'music-error';
                                                            errorMsg.textContent = 'éŸ³é¢‘æ’­æ”¾å¤±è´¥: ' + e.message;
                                                            musicCard.appendChild(errorMsg);
                                                        });
                                                    }, 100);
                                                }, 100);
                                            })
                                            .finally(function() {
                                                // æ ‡è®°éŸ³é¢‘æ“ä½œå®Œæˆ
                                                isAudioOperationInProgress = false;
                                            });
                                    } else {
                                        console.log('éŸ³é¢‘å·²ç»åœ¨æ’­æ”¾ï¼Œä¸éœ€è¦é‡å¤è°ƒç”¨play()');
                                        isAudioOperationInProgress = false;
                                    }
                                });
                            } else {
                                console.log('å°è¯•æš‚åœéŸ³é¢‘...');
                                audioElement.pause();
                                console.log('éŸ³é¢‘æš‚åœæˆåŠŸ');
                                playIcon.style.display = 'inline';
                                pauseIcon.style.display = 'none';
                                
                                // å‘é€æš‚åœäº‹ä»¶ç»™æœåŠ¡å™¨
                                socket.emit('music_play', {
                                    music: musicData,
                                    status: 'pause'
                                });
                            }
                        } catch (error) {
                            console.error('æ’­æ”¾æŒ‰é’®ç‚¹å‡»äº‹ä»¶å¤„ç†å¤±è´¥:', error);
                            isAudioOperationInProgress = false;
                        }
                    } else {
                        console.error('éŸ³é¢‘å…ƒç´ ä¸å­˜åœ¨');
                    }
                });
                
                // åœæ­¢æŒ‰é’®äº‹ä»¶
                stopBtn.addEventListener('click', function() {
                    if (audioElement) {
                        // æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–éŸ³é¢‘æ“ä½œæ­£åœ¨è¿›è¡Œ
                        if (isAudioOperationInProgress) {
                            console.log('æœ‰å…¶ä»–éŸ³é¢‘æ“ä½œæ­£åœ¨è¿›è¡Œï¼Œæš‚æ—¶å¿½ç•¥å½“å‰è¯·æ±‚');
                            return;
                        }
                        
                        // å¦‚æœå½“å‰æ˜¯æ´»è·ƒéŸ³é¢‘ï¼Œä½¿ç”¨stopActiveAudioå‡½æ•°
                        if (activeAudioElement === audioElement) {
                            stopActiveAudio();
                        } else {
                            // å¦åˆ™ç›´æ¥åœæ­¢è¯¥éŸ³é¢‘
                            audioElement.pause();
                            audioElement.currentTime = 0;
                            playIcon.style.display = 'inline';
                            pauseIcon.style.display = 'none';
                        }
                        
                        // é‡ç½®UI
                        progress.style.width = '0%';
                        timeDisplay.textContent = '0:00';
                        
                        // å‘é€åœæ­¢äº‹ä»¶ç»™æœåŠ¡å™¨
                        socket.emit('music_play', {
                            music: musicData,
                            status: 'stop'
                        });
                    }
                });
                
                // æ›´æ–°è¿›åº¦æ¡
                audioElement.addEventListener('timeupdate', function() {
                    const duration = audioElement.duration;
                    const currentTime = audioElement.currentTime;
                    
                    if (duration > 0) {
                        const progressPercent = (currentTime / duration) * 100;
                        progress.style.width = progressPercent + '%';
                        
                        // æ›´æ–°æ—¶é—´æ˜¾ç¤º
                        const minutes = Math.floor(currentTime / 60);
                        const seconds = Math.floor(currentTime % 60);
                        timeDisplay.textContent = minutes + ':' + (seconds < 10 ? '0' + seconds : seconds);
                    }
                });
                
                // ç‚¹å‡»è¿›åº¦æ¡è·³è½¬åˆ°æŒ‡å®šä½ç½®
                progressContainer.addEventListener('click', function(e) {
                    if (!audioElement.duration) return;
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–éŸ³é¢‘æ“ä½œæ­£åœ¨è¿›è¡Œ
                    if (isAudioOperationInProgress) {
                        console.log('æœ‰å…¶ä»–éŸ³é¢‘æ“ä½œæ­£åœ¨è¿›è¡Œï¼Œæš‚æ—¶å¿½ç•¥è¿›åº¦æ¡è·³è½¬è¯·æ±‚');
                        return;
                    }
                    
                    // è®¾ç½®éŸ³é¢‘æ“ä½œè¿›è¡Œä¸­æ ‡å¿—
                    isAudioOperationInProgress = true;
                    
                    // è®°å½•å½“å‰æ’­æ”¾çŠ¶æ€
                    const wasPlaying = !audioElement.paused;
                    
                    // è·å–ç‚¹å‡»ä½ç½®å¹¶è®¾ç½®å½“å‰æ—¶é—´
                    const rect = progressContainer.getBoundingClientRect();
                    const pos = (e.clientX - rect.left) / rect.width;
                    audioElement.currentTime = pos * audioElement.duration;
                    
                    // å¦‚æœä¹‹å‰æ˜¯æ’­æ”¾çŠ¶æ€ï¼Œç­‰å¾…seekedäº‹ä»¶åå†æ¢å¤æ’­æ”¾
                    if (wasPlaying) {
                        // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§äº‹ä»¶ç›‘å¬å™¨
                        audioElement.removeEventListener('seeked', handleSeeked);
                        
                        // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
                        function handleSeeked() {
                            // ç¡®ä¿éŸ³é¢‘å…ƒç´ å­˜åœ¨ä¸”æ²¡æœ‰è¢«ç§»é™¤
                            if (audioElement && audioElement.parentNode) {
                                audioElement.play()
                                    .then(function() {
                                        console.log('è¿›åº¦æ¡è·³è½¬åæ’­æ”¾æˆåŠŸ');
                                    })
                                    .catch(e => {
                                        console.error('æ‹–åŠ¨è¿›åº¦åæ’­æ”¾å¤±è´¥:', e);
                                        // æ’­æ”¾å¤±è´¥æ—¶æ¢å¤æ’­æ”¾æŒ‰é’®çŠ¶æ€
                                        if (audioElement.paused) {
                                            playIcon.style.display = 'inline';
                                            pauseIcon.style.display = 'none';
                                        }
                                    })
                                    .finally(function() {
                                        // æ ‡è®°éŸ³é¢‘æ“ä½œå®Œæˆ
                                        isAudioOperationInProgress = false;
                                    });
                            } else {
                                // éŸ³é¢‘å…ƒç´ ä¸å­˜åœ¨ï¼Œæ ‡è®°æ“ä½œå®Œæˆ
                                isAudioOperationInProgress = false;
                            }
                            // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
                            audioElement.removeEventListener('seeked', handleSeeked);
                        }
                        
                        audioElement.addEventListener('seeked', handleSeeked);
                    } else {
                        // å¦‚æœä¹‹å‰æ˜¯æš‚åœçŠ¶æ€ï¼Œç›´æ¥æ ‡è®°æ“ä½œå®Œæˆ
                        isAudioOperationInProgress = false;
                    }
                });
                
                // éŸ³ä¹æ’­æ”¾ç»“æŸ
                audioElement.addEventListener('ended', function() {
                    playIcon.style.display = 'inline';
                    pauseIcon.style.display = 'none';
                    progress.style.width = '100%';
                });
            }
        }
        
        // æ ¹æ®å¤©æ°”æ›´æ–°èƒŒæ™¯
        function updateBackgroundByWeather(weatherCondition) {
            const body = document.body;
            // ç§»é™¤æ‰€æœ‰å¤©æ°”ç›¸å…³çš„èƒŒæ™¯ç±»
            body.classList.remove('weather-sunny', 'weather-cloudy', 'weather-rainy', 'weather-snowy');
            
            // æ ¹æ®å¤©æ°”æ¡ä»¶æ·»åŠ å¯¹åº”çš„èƒŒæ™¯ç±»
            if (!weatherCondition) return;
            
            const condition = weatherCondition.toLowerCase();
            if (condition.includes('æ™´')) {
                body.classList.add('weather-sunny');
            } else if (condition.includes('äº‘')) {
                body.classList.add('weather-cloudy');
            } else if (condition.includes('é›¨')) {
                body.classList.add('weather-rainy');
            } else if (condition.includes('é›ª')) {
                body.classList.add('weather-snowy');
            }
        }
        
        // æ›´æ–°èƒŒæ™¯é¢œè‰²
        function updateBackgroundColor(color) {
            const body = document.body;
            if (color) {
                // è®¾ç½®åŠé€æ˜èƒŒæ™¯è‰²ï¼Œä¿ç•™å£çº¸çš„æ˜¾ç¤º
                body.style.backgroundColor = color;
                body.style.backgroundBlendMode = 'overlay';
            }
        }

        // å¤„ç†éŸ³ä¹æ’­æ”¾åŒæ­¥äº‹ä»¶
        function handleMusicPlaying(data) {
            // æ˜¾ç¤ºéŸ³ä¹å¼€å§‹æ’­æ”¾çš„é€šçŸ¥
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message music-notification';
            
            const messageHeader = document.createElement('div');
            messageHeader.className = 'message-header';
            messageHeader.textContent = `èåœå­`;
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            if (data.played_by && data.played_by !== 'system') {
                messageContent.textContent = `${data.played_by} æ­£åœ¨æ’­æ”¾éŸ³ä¹: ${data.music.title} - ${data.music.artist}`;
            } else {
                messageContent.textContent = `æ­£åœ¨æ’­æ”¾éŸ³ä¹: ${data.music.title} - ${data.music.artist}`;
            }
            
            messageDiv.appendChild(messageHeader);
            messageDiv.appendChild(messageContent);
            
            document.getElementById('messages').appendChild(messageDiv);
            scrollToBottom();
            
            // åˆ›å»ºéŸ³ä¹å¡ç‰‡ï¼Œè¿™æ ·æ‰€æœ‰ç”¨æˆ·éƒ½èƒ½çœ‹åˆ°å’Œæ’­æ”¾éŸ³ä¹
            const musicCardDiv = document.createElement('div');
            musicCardDiv.className = 'message';
            musicCardDiv.classList.add('music-message'); // æ·»åŠ ç‰¹æ®Šç±»ä¾¿äºè¯†åˆ«
            musicCardDiv.dataset.musicTitle = data.music.title;
            
            const musicHeader = document.createElement('div');
            musicHeader.className = 'message-header';
            musicHeader.textContent = `éŸ³ä¹`;
            
            const musicContent = document.createElement('div');
            musicContent.className = 'message-content';
            
            displayMusicPlayer(data.music, musicContent);
            
            musicCardDiv.appendChild(musicHeader);
            musicCardDiv.appendChild(musicContent);
            
            // æ¸…ç†æ—§çš„éŸ³ä¹æ¶ˆæ¯å¡ç‰‡ï¼Œåªä¿ç•™æœ€æ–°çš„2ä¸ª
            const existingMusicMessages = document.querySelectorAll('.music-message');
            if (existingMusicMessages.length > 2) {
                for (let i = 0; i < existingMusicMessages.length - 2; i++) {
                    console.log('æ¸…ç†æ—§çš„éŸ³ä¹æ¶ˆæ¯å¡ç‰‡');
                    existingMusicMessages[i].remove();
                }
            }
            
            document.getElementById('messages').appendChild(musicCardDiv);
            scrollToBottom();
            
            // æ ¹æ®éŸ³ä¹æ›´æ–°èƒŒæ™¯é¢œè‰²
            if (data.music.color) {
                updateBackgroundColor(data.music.color);
            }
        }
        
        // å¤„ç†éŸ³ä¹åŒæ­¥äº‹ä»¶
        socket.on('music_sync', function(data) {
            if (!data || !data.music || !data.status) return;
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰ç”¨æˆ·è§¦å‘çš„äº‹ä»¶ï¼Œå¦‚æœæ˜¯åˆ™å¿½ç•¥
            // è¿™æ ·å¯ä»¥é¿å…è‡ªå·±è§¦å‘çš„äº‹ä»¶åˆè¢«è‡ªå·±å¤„ç†ï¼Œå¯¼è‡´çŠ¶æ€æ··ä¹±
            if (data.played_by === username) {
                console.log('å¿½ç•¥è‡ªå·±è§¦å‘çš„éŸ³ä¹åŒæ­¥äº‹ä»¶');
                return;
            }
            
            console.log('æ”¶åˆ°éŸ³ä¹åŒæ­¥äº‹ä»¶:', data);
            
            // å¦‚æœæ˜¯æ’­æ”¾æ–°éŸ³ä¹ï¼Œå…ˆæ¸…ç†æ—§çš„éŸ³ä¹å¡ç‰‡å’ŒéŸ³é¢‘å…ƒç´ 
            if (data.status === 'play') {
                console.log('åŒæ­¥æ’­æ”¾æ–°éŸ³ä¹ï¼Œå…ˆæ¸…ç†æ—§çš„éŸ³ä¹å…ƒç´ ');
                
                // æ¸…ç†æ‰€æœ‰æ—§çš„éŸ³ä¹å¡ç‰‡å’ŒéŸ³é¢‘å…ƒç´ 
                const allMusicCards = document.querySelectorAll('.music-card');
                allMusicCards.forEach(card => {
                    const cardAudioId = card.dataset.audioId;
                    if (cardAudioId) {
                        const oldAudio = document.getElementById(cardAudioId);
                        if (oldAudio) {
                            console.log('æ¸…ç†æ—§éŸ³é¢‘å…ƒç´ :', cardAudioId);
                            try {
                                oldAudio.pause();
                                oldAudio.currentTime = 0;
                                document.body.removeChild(oldAudio);
                            } catch (error) {
                                console.error('æ¸…ç†æ—§éŸ³é¢‘å…ƒç´ å¤±è´¥:', error);
                            }
                        }
                    }
                    // ä»çˆ¶å®¹å™¨ä¸­ç§»é™¤æ—§å¡ç‰‡
                    if (card.parentNode) {
                        card.parentNode.removeChild(card);
                    }
                });
                
                // é‡ç½®æ´»è·ƒéŸ³é¢‘çŠ¶æ€
                activeAudioElement = null;
                activeMusicCard = null;
                isAudioStopping = false;
                isAudioOperationInProgress = false;
            }
            
            // æŸ¥æ‰¾å¯¹åº”çš„éŸ³ä¹å¡ç‰‡
            const musicCards = document.querySelectorAll('.music-card');
            let targetCard = null;
            
            // é€šè¿‡éŸ³ä¹IDæˆ–æ ‡é¢˜åŒ¹é…å¡ç‰‡
            musicCards.forEach(card => {
                const cardMusicId = card.dataset.musicId;
                const cardTitle = card.querySelector('.music-title')?.textContent;
                
                if (cardMusicId === data.music.id || 
                    cardTitle === data.music.title) {
                    targetCard = card;
                }
            });
            
            if (targetCard) {
                const audioId = targetCard.dataset.audioId;
                if (audioId) {
                    const audioElement = document.getElementById(audioId);
                    if (audioElement) {
                        const playIcon = targetCard.querySelector('.play-icon');
                        const pauseIcon = targetCard.querySelector('.pause-icon');
                        const progressBar = targetCard.querySelector('.music-progress');
                        const timeDisplay = targetCard.querySelector('.music-time');
                        
                        // æ ¹æ®çŠ¶æ€æ‰§è¡Œç›¸åº”æ“ä½œ
                            switch(data.status) {
                                case 'play':
                                    // ç¡®ä¿ä¸ä¼šåœ¨éŸ³é¢‘æ­£åœ¨æ’­æ”¾æ—¶é‡å¤è°ƒç”¨play()
                                    if (audioElement.paused && !isAudioOperationInProgress) {
                                        console.log('æ”¶åˆ°æ’­æ”¾åŒæ­¥äº‹ä»¶ï¼Œå¼€å§‹æ’­æ”¾éŸ³é¢‘');
                                        audioElement.play().catch(e => console.error('æ’­æ”¾å¤±è´¥:', e));
                                    } else {
                                        console.log('éŸ³é¢‘å·²ç»åœ¨æ’­æ”¾æˆ–æœ‰å…¶ä»–æ“ä½œæ­£åœ¨è¿›è¡Œï¼Œå¿½ç•¥åŒæ­¥æ’­æ”¾è¯·æ±‚');
                                    }
                                    if (playIcon) playIcon.style.display = 'none';
                                    if (pauseIcon) pauseIcon.style.display = 'inline';
                                    break;
                                case 'pause':
                                    // ç¡®ä¿ä¸ä¼šåœ¨éŸ³é¢‘å·²ç»æš‚åœæ—¶é‡å¤è°ƒç”¨pause()
                                    if (!audioElement.paused && !isAudioOperationInProgress) {
                                        console.log('æ”¶åˆ°æš‚åœåŒæ­¥äº‹ä»¶ï¼Œæš‚åœéŸ³é¢‘');
                                        audioElement.pause();
                                    } else {
                                        console.log('éŸ³é¢‘å·²ç»æš‚åœæˆ–æœ‰å…¶ä»–æ“ä½œæ­£åœ¨è¿›è¡Œï¼Œå¿½ç•¥åŒæ­¥æš‚åœè¯·æ±‚');
                                    }
                                    if (playIcon) playIcon.style.display = 'inline';
                                    if (pauseIcon) pauseIcon.style.display = 'none';
                                    break;
                                case 'stop':
                                    if (!isAudioOperationInProgress) {
                                        console.log('æ”¶åˆ°åœæ­¢åŒæ­¥äº‹ä»¶ï¼Œåœæ­¢éŸ³é¢‘');
                                        audioElement.pause();
                                        audioElement.currentTime = 0;
                                    } else {
                                        console.log('æœ‰å…¶ä»–éŸ³é¢‘æ“ä½œæ­£åœ¨è¿›è¡Œï¼Œå¿½ç•¥åŒæ­¥åœæ­¢è¯·æ±‚');
                                    }
                                    if (playIcon) playIcon.style.display = 'inline';
                                    if (pauseIcon) pauseIcon.style.display = 'none';
                                    if (progressBar) progressBar.style.width = '0%';
                                if (timeDisplay) timeDisplay.textContent = '0:00';
                                break;
                        }
                    }
                }
                
                // æ˜¾ç¤ºåŒæ­¥é€šçŸ¥
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message music-notification';
                
                const messageHeader = document.createElement('div');
                messageHeader.className = 'message-header';
                messageHeader.textContent = 'èåœå­';
                
                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';
                
                let statusText = '';
                switch(data.status) {
                    case 'play': statusText = 'æ’­æ”¾'; break;
                    case 'pause': statusText = 'æš‚åœ'; break;
                    case 'stop': statusText = 'åœæ­¢'; break;
                }
                
                messageContent.textContent = `${data.played_by} å·²${statusText}éŸ³ä¹: ${data.music.title} - ${data.music.artist}`;
                
                messageDiv.appendChild(messageHeader);
                messageDiv.appendChild(messageContent);
                
                document.getElementById('messages').appendChild(messageDiv);
                scrollToBottom();
            }
        });
        
        // å¤„ç†é”™è¯¯äº‹ä»¶
        socket.on('error', function(error) {
            console.error('Socketé”™è¯¯:', error);
            alert('å‘ç”Ÿé”™è¯¯: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
        });

        function scrollToBottom() {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        // åˆå§‹åŒ–é¡µé¢
        window.addEventListener('load', function() {
            document.getElementById('message-input').focus();
            
            // ç¡®ä¿socketè¿æ¥å·²ç»å»ºç«‹
            if (!socket.connected) {
                console.log('é‡æ–°è¿æ¥Socket.IO...');
                socket.connect();
            }
            
            // ç§»é™¤ä»»ä½•å¯èƒ½å­˜åœ¨çš„æ®‹ç•™æ¨¡æ€æ¡†
            let modal = document.getElementById('input-modal');
            if (modal) {
                modal.remove();
            }
        });
    </script>
</body>
</html>